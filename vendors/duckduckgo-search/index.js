import N from"node:https";var L=/<[^>]*>/g;function C(u){return u?decodeURIComponent(u).replace(/ /g,"+"):""}function b(u,t){if(!t)return"";let e=t.replace(L,""),n=u.createElement("textarea");return n.innerHTML=e,n.value}import M from"axios";import{JSDOM as U}from"jsdom";var g=class extends Error{constructor(t){super(t),this.name="DuckDuckGoSearchError"}},v=class extends g{constructor(t){super(t),this.name="RatelimitError"}},k=class extends g{constructor(t){super(t),this.name="TimeoutError"}};import p from"winston";var r=p.createLogger({level:"info",format:p.format.combine(p.format.timestamp(),p.format.json()),transports:[]});process.env.NODE_ENV!=="production"&&process.env.duckduckgo_search_log?.trim()==="enable"&&r.add(new p.transports.Console({format:p.format.simple()}));var T=class u{client;sleepTimestamp=0;static IMPERSONATES=["chrome_100","chrome_101","chrome_104","chrome_105","chrome_106","chrome_107","chrome_108","chrome_109","chrome_114","chrome_116","chrome_117","chrome_118","chrome_119","chrome_120","chrome_123","chrome_124","chrome_126","chrome_127","chrome_128","chrome_129","chrome_130","chrome_131","safari_ios_16.5","safari_ios_17.2","safari_ios_17.4.1","safari_ios_18.1.1","safari_15.3","safari_15.5","safari_15.6.1","safari_16","safari_16.5","safari_17.0","safari_17.2.1","safari_17.4.1","safari_17.5","safari_18","safari_18.2","safari_ipad_18","edge_101","edge_122","edge_127","edge_131","firefox_109","firefox_117","firefox_128","firefox_133"];constructor(t={}){let{headers:e={},proxy:n,timeout:s=1e4,verify:i=!0}=t;r.info("Initializing DDGS with options",{proxy:n,timeout:s,verify:i}),this.client=M.create({timeout:s,headers:{...e,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","Accept-Language":"en-GB,en-US;q=0.9,en;q=0.8","Cache-Control":"max-age=0","Content-Type":"application/x-www-form-urlencoded","Sec-Ch-Ua":'"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',"Sec-Ch-Ua-Mobile":"?0","Sec-Ch-Ua-Platform":'"Linux"',"Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"same-origin","Sec-Fetch-User":"?1",Referer:"https://duckduckgo.com/","User-Agent":this.getRandomUserAgent()},proxy:n?{host:new URL(n).hostname,port:Number(new URL(n).port),protocol:new URL(n).protocol.slice(0,-1)}:void 0,httpsAgent:i?void 0:new N.Agent({rejectUnauthorized:!1,keepAlive:!0})})}getRandomUserAgent(){let t=u.IMPERSONATES[Math.floor(Math.random()*u.IMPERSONATES.length)];return r.debug("Selected random user agent",{userAgent:t}),t}async sleep(t=.75){let e=Date.now()/1e3,n=this.sleepTimestamp?e-this.sleepTimestamp>=20?0:t*1e3:0;this.sleepTimestamp=e,r.debug("Sleeping",{delay:n}),await new Promise(s=>setTimeout(s,n))}async getUrl(t){r.info("Making request",{method:t.method,url:t.url}),await this.sleep();try{let e=await this.client.request({...t,data:t.data});if(e.status===200)return r.debug("Request successful",{status:e.status,url:t.url}),e.data;throw[202,301,403].includes(e.status)?(r.warn("Ratelimit hit",{status:e.status,url:t.url}),new v(`${e.config.url} ${e.status} Ratelimit`)):(r.error("Unexpected status code",{status:e.status,url:t.url}),new g(`${e.config.url} returned unexpected status ${e.status}`))}catch(e){throw e instanceof v?e:e.message.toLowerCase().includes("timeout")?(r.error("Request timeout",{url:t.url,error:e.message}),new k(`${t.url} request timed out`)):(r.error("Request failed",{url:t.url,error:e.message}),new g(`${t.url} request failed: ${e.message}`))}}async text(t){let{keywords:e,region:n="wt-wt",safesearch:s="moderate",timelimit:i=null,backend:h="auto",maxResults:o=null}=t;if(r.info("Starting text search",{keywords:e,region:n,safesearch:s,timelimit:i,backend:h,maxResults:o}),!e)throw r.error("No keywords provided"),new g("keywords is mandatory");let m=h==="auto"?["html","lite"]:[h];m.sort(()=>Math.random()-.5),r.debug("Selected backends",{backends:m});let d=[],w=null;for(let a of m)try{return a==="html"?d=await this.textHtml(e,n,i,o):a==="lite"&&(d=await this.textLite(e,n,i,o)),r.info("Search completed successfully",{backend:a,resultCount:d.length}),d}catch(_){r.error(`Error searching using ${a} backend`,{error:_.message}),w=_}throw r.error("All backends failed",{lastError:w?.message}),new g(w?.message||"Search failed")}async textHtml(t,e="wt-wt",n=null,s=null){r.info("Starting HTML search",{keywords:t,region:e,timelimit:n,maxResults:s});let i={q:t,s:"0",o:"json",api:"d.js",vqd:"",kl:e,bing_market:e,...n&&{df:n}},h=new Set,o=[];for(let m=0;m<5;m++){r.debug("Fetching page",{pageNumber:m+1});let d=await this.getUrl({method:"POST",url:"https://html.duckduckgo.com/html",data:i}),w=new U(d),a=w.window.document,_=a.querySelectorAll("div:has(h2)");if(d.includes("No results."))return r.info("No results found"),o;for(let f of _){let c=f.querySelector("a")?.href;if(!c||h.has(c)||c.startsWith("http://www.google.com/search?q=")||c.startsWith("https://duckduckgo.com/y.js?ad_domain"))continue;h.add(c);let l=f.querySelector("h2 a")?.textContent||"",q=Array.from(f.querySelectorAll("a")).map(A=>A.textContent).join("");if(o.push({title:b(a,l),href:C(c),body:b(a,q)}),s&&o.length>=s)return r.info("Reached maximum results limit",{resultCount:o.length}),o}let S=w.window.document.querySelectorAll(".nav-link"),x=S[S.length-1];if(!x||!s)return r.info("No more pages to fetch",{resultCount:o.length}),o;let y={};x.querySelectorAll('input[type="hidden"]').forEach(f=>{let c=f.getAttribute("name"),l=f.getAttribute("value");c&&l!==null&&(y[c]=l)}),i=y}return r.info("Search completed",{resultCount:o.length}),o}async textLite(t,e="wt-wt",n=null,s=null){r.info("Starting HTML lite search",{keywords:t,region:e,timelimit:n,maxResults:s});let i={q:t,s:"0",o:"json",api:"d.js",vqd:"",kl:e,bing_market:e,...n&&{df:n}},h=new Set,o=[];for(let m=0;m<5;m++){let d=await this.getUrl({method:"POST",url:"https://lite.duckduckgo.com/lite",data:i});if(d.includes("No more results."))return r.info("No more results found"),o;let a=new U(d).window.document,_=a.querySelectorAll("table"),S=_[_.length-1].querySelectorAll("tr");if(!S.length)return o;for(let y=0;y<S.length;y+=4){let R=S[y],f=S[y+1];if(!R||!f)continue;let c=R.querySelector("a"),l=c?.href;if(!l||h.has(l)||l.startsWith("http://www.google.com/search?q=")||l.startsWith("https://duckduckgo.com/y.js?ad_domain"))continue;h.add(l);let q=c?.textContent||"",A=f.querySelector(".result-snippet")?.textContent?.trim()||"";if(o.push({title:b(a,q),href:C(l),body:b(a,A)}),s&&o.length>=s)return r.info("Reached maximum results limit",{resultCount:o.length}),o}let x=a.querySelector("form input[name='s'][value]");if(!x?.value||!s)return r.info("No more pages to fetch",{resultCount:o.length}),o;i.s=x.value}return r.info("Search completed",{resultCount:o.length}),o}};export{T as DDGS};
